using System.Collections.Generic;
using JetBrains.Annotations;
using UnityEngine;
using UnityEngine.UI;

public class JokerManager : MonoBehaviour
{    public static JokerManager Instance { get; private set; }
    [SerializeField] private List<Button> jokerButtons;
    private Dictionary<JokerType, JokerBase> jokers = new();
    public JokerBase CurrentJoker { get; private set; }

    private void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }
        Instance = this;
    }

    private void Start()
    {
        CreateJokers();
        SetupJokerButtons();
    }

    private void CreateJokers()
    {
        jokers.Clear();

        var switchSprite = Resources.Load<Sprite>("Icons/Switch");
        var replaceSprite = Resources.Load<Sprite>("Icons/ReplaceTile");
        var freezeSprite = Resources.Load<Sprite>("Icons/FreezeTime");

        int switchCount = PlayerPrefs.GetInt("Joker_Switch", 10);
        int replaceCount = PlayerPrefs.GetInt("Joker_ReplaceTile", 10);
        int freezeCount = PlayerPrefs.GetInt("Joker_FreezeTime", 10);
        int showPathCount = PlayerPrefs.GetInt("Joker_ShowPath", 10);
        int extraMoveCount = PlayerPrefs.GetInt("Joker_ExtraMove", 10);

        jokers.Add(
            JokerType.Switch,
            new SwitchJoker { icon = switchSprite, Count = switchCount }
        );

        jokers.Add(
            JokerType.ReplaceTile,
            new ReplaceTileJoker(Resources.Load<GameObject>("Prefabs/riverCross")) { icon = replaceSprite, Count = replaceCount }
        );

        // Freeze time joker
        jokers.Add(
            JokerType.FreezeTime,
            new FreezeTimeJoker(7f) { icon = freezeSprite, Count = freezeCount }
        );

        var showPathSprite = Resources.Load<Sprite>("Icons/ShowPath");
        jokers.Add(
            JokerType.ShowPath,
            new ShowPathJoker(5f) { icon = showPathSprite, Count = showPathCount }
        );

        // Extra move joker (grants extra moves when used)
        jokers.Add(
            JokerType.ExtraMove,
            new ExtraMoveJoker(1) { icon = Resources.Load<Sprite>("Icons/ExtraMove"), Count = extraMoveCount }
        );
    }

    private void SetupJokerButtons()
    {
        // Order buttons: Switch, Replace, Freeze, ShowPath, ExtraMove
        var order = new JokerType[] { JokerType.Switch, JokerType.ReplaceTile, JokerType.FreezeTime, JokerType.ShowPath, JokerType.ExtraMove };
        for (int i = 0; i < jokerButtons.Count && i < order.Length; i++)
        {
            BindButton(jokerButtons[i], order[i]);
        }

    }

    private void BindButton(Button button, JokerType type)
    {
        var joker = jokers[type];
        button.image.sprite = joker.icon;

        button.onClick.RemoveAllListeners();
        button.onClick.AddListener(() => SelectJoker(type));
        // show availability
        button.interactable = joker.Count > 0;
    }

    public void SelectJoker(JokerType type)
    {
        if (!jokers.ContainsKey(type)) return;

        var joker = jokers[type];
        if (joker.Count <= 0)
        {
            Debug.Log("No joker available to select: " + type);
            return;
        }

        CurrentJoker = joker;
        Debug.Log("Selected Joker: " + type);

        // If freeze-time, show-path or extra-move joker selected, activate immediately (no tile click needed)
        if (type == JokerType.FreezeTime || type == JokerType.ShowPath || type == JokerType.ExtraMove)
        {
            // Use centralized UseJoker so consumption and validation is handled consistently
            UseJoker(default, default);
        }
    }

    public void DeselectJoker()
    {
        CurrentJoker = null;
    }

    public void UseJoker(Vector2Int selectedTile, Vector2Int targetTile)
    {
        if (CurrentJoker == null) return;

        if (CurrentJoker.Count <= 0)
        {
            Debug.Log("No joker left");
            return;
        }

        // Prevent using jokers on start or end tiles
        var currentLevel = LevelManager.instance?.GetCurrentLevelData();
        if (currentLevel != null)
        {
            if (selectedTile == currentLevel.startCoord || selectedTile == currentLevel.endCoord
                || targetTile == currentLevel.startCoord || targetTile == currentLevel.endCoord)
            {
                Debug.Log("Cannot use joker on start or end tile.");
                return;
            }
        }

        CurrentJoker.Use(selectedTile, targetTile);
        // Decrement centralized count and persist
        CurrentJoker.Count--;
        PlayerPrefs.SetInt("Joker_" + CurrentJoker.type.ToString(), CurrentJoker.Count);
        PlayerPrefs.Save();
        DeselectJoker();
        // Refresh button states
        SetupJokerButtons();
    }

    // Utility: check if coord is start or end of current level
    public bool IsStartOrEnd(Vector2Int coord)
    {
        var level = LevelManager.instance?.GetCurrentLevelData();
        if (level == null) return false;
        return coord == level.startCoord || coord == level.endCoord;
    }

}
[System.Serializable]
public class Joker
{
    public JokerType type;
    public Sprite icon;
    public int Count = 1;

    public Joker( JokerType type, Sprite icon,int Count)
    {
        this.type = type;
        this.icon = icon;
        this.Count = Count;
    }
}
    public enum JokerType
    {
        None,
        Switch,
        AllDirections,
        FreezeTime,
        ExtraMove,
        ShowPath,
        ReplaceTile
    }
